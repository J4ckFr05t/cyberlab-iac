---
- name: Download Wazuh installation script
  ansible.builtin.get_url:
    url: "{{ wazuh_installer_url }}"
    dest: /root/wazuh-install.sh
    mode: '0755'

- name: Run Wazuh installation script (all-in-one)
  ansible.builtin.shell: bash ./wazuh-install.sh -a
  args:
    chdir: /root
    creates: /var/ossec/bin/wazuh-control
  register: wazuh_install_output

- name: Display Wazuh installation output
  ansible.builtin.debug:
    var: wazuh_install_output.stdout_lines
  when: wazuh_install_output.changed

- name: Comment out Wazuh repo in sources.list to prevent accidental updates
  ansible.builtin.replace:
    path: /etc/apt/sources.list.d/wazuh.list
    regexp: '^deb '
    replace: '#deb '

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes

- name: Check if Wazuh installation archive exists
  ansible.builtin.stat:
    path: /root/wazuh-install-files.tar
  register: wazuh_tar_file

- name: Fail if Wazuh installation archive is missing
  ansible.builtin.fail:
    msg: "The Wazuh installation archive '/root/wazuh-install-files.tar' was not found. Installation may have failed or files were removed."
  when: not wazuh_tar_file.stat.exists

- name: Extract Wazuh passwords from installation archive
  ansible.builtin.shell: tar -O -xvf wazuh-install-files.tar wazuh-install-files/wazuh-passwords.txt
  args:
    chdir: /root
  register: wazuh_passwords_output

- name: Ensure local files directory exists
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../files"
    state: directory
    mode: '0755'
  delegate_to: localhost
  become: false

- name: Save Wazuh passwords to local file
  ansible.builtin.copy:
    content: "{{ wazuh_passwords_output.stdout }}"
    dest: "{{ playbook_dir }}/../files/wazuh_passwords.txt"
  delegate_to: localhost
  become: false

- name: Update Wazuh admin password
  ansible.builtin.shell: >
    /usr/share/wazuh-indexer/plugins/opensearch-security/tools/wazuh-passwords-tool.sh 
    -u {{ wazuh_admin_username }} 
    -p '{{ wazuh_admin_password }}'
  no_log: true
  when: wazuh_admin_password is defined

- name: Extract original Wazuh API password
  ansible.builtin.set_fact:
    wazuh_original_api_pass: "{{ wazuh_passwords_output.stdout | regex_search(\"api_password: '(.+)'\", '\\1') | first }}"

- name: Update Wazuh API user password
  ansible.builtin.shell: >
    /usr/share/wazuh-indexer/plugins/opensearch-security/tools/wazuh-passwords-tool.sh 
    -A 
    -u wazuh 
    -p '{{ wazuh_api_password }}' 
    -au wazuh 
    -ap '{{ wazuh_original_api_pass }}'
  no_log: true
  when: wazuh_api_password is defined and wazuh_original_api_pass is defined

- name: Verify Wazuh API connection with new password
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:55000/security/user/authenticate?raw=true"
    method: POST
    user: wazuh
    password: "{{ wazuh_api_password }}"
    validate_certs: no
    force_basic_auth: yes
  register: api_check
  failed_when: api_check.status != 200
  when: wazuh_api_password is defined
