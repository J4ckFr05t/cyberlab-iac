---
- name: Check if Elasticsearch is installed
  command: dpkg-query -W -f='${Status}' elasticsearch
  register: elastic_check
  failed_when: false
  changed_when: false
  become: yes

- name: Install Elasticsearch and Capture Password
  shell: apt-get install elasticsearch -y
  register: elastic_install_output
  become: yes
  when: elastic_check.stdout.find('install ok installed') == -1

- name: Configure Elasticsearch Heap Size
  copy:
    content: |
      -Xms4g
      -Xmx4g
    dest: /etc/elasticsearch/jvm.options.d/heap.options
    mode: '0644'
  become: yes
  notify: Restart Elasticsearch

- name: Extract Elastic User Password from Install
  set_fact:
    elastic_password: "{{ elastic_install_output.stdout | regex_search('The generated password for the elastic built-in superuser is : (.+)', '\\1') | first }}"
  when: elastic_install_output.changed and 'The generated password for the elastic built-in superuser is :' in elastic_install_output.stdout

- name: Check if password was captured
  set_fact:
    password_captured: "{{ elastic_password is defined and elastic_password | length > 0 }}"

- name: Debug Install Output (If Password Missing)
  debug:
    var: elastic_install_output.stdout_lines
  when: not password_captured

- name: Reset Elastic Password (Fallback)
  command: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -b
  register: password_reset_output
  become: yes
  when: not password_captured

- name: Debug Reset Output
  debug:
    var: password_reset_output.stdout
  when: not password_captured and password_reset_output is defined

- name: Extract Elastic User Password from Reset
  set_fact:
    elastic_password: "{{ password_reset_output.stdout | regex_search('New value: (.*)', '\\1') | trim }}"
  when: not password_captured and password_reset_output.rc == 0

- name: Verify Password Variable
  debug:
    msg: "Captured Password: {{ elastic_password }}"

- name: Ensure generated credentials directory exists
  local_action:
    module: file
    path: "{{ playbook_dir }}/../files/generated_creds"
    state: directory
    mode: '0700'
  become: no
  run_once: true

- name: Save Elastic Password
  local_action:
    module: copy
    content: "{{ elastic_password }}"
    dest: "{{ playbook_dir }}/../files/generated_creds/elastic_password.txt"
  become: no
  when: elastic_password is defined and elastic_password | length > 0

- name: Start and Enable Elasticsearch
  systemd:
    name: elasticsearch
    state: started
    enabled: yes
  become: yes
