---
- name: Ensure Temp Directory Exists
  win_file:
    path: C:\Temp
    state: directory

- name: Download Wazuh Agent MSI
  win_get_url:
    url: "{{ wazuh_agent_windows_url }}"
    dest: C:\Temp\wazuh-agent.msi
    force: no

- name: Install Wazuh Agent (Silent)
  win_package:
    path: C:\Temp\wazuh-agent.msi
    state: present

- name: Stop Wazuh agent service to prevent file locks
  win_service:
    name: WazuhSvc
    state: stopped

- name: Configure Wazuh agent (Server Connection)
  win_shell: |
    $path = "C:\Program Files (x86)\ossec-agent\ossec.conf"
    if (-not (Test-Path $path)) {
        Write-Error "ossec.conf not found at $path"
        exit 1
    }

    $xml = New-Object System.Xml.XmlDocument
    try {
        $xml.Load($path)
    } catch {
        Write-Error "Failed to load XML: $_"
        exit 1
    }

    $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)

    # Helper function to ensure node exists
    function Ensure-Node ($parent, $nodeName) {
        $node = $parent.SelectSingleNode($nodeName)
        if ($null -eq $node) {
            $node = $xml.CreateElement($nodeName)
            $parent.AppendChild($node) | Out-Null
        }
        return $node
    }

    # Ensure Structure
    $client = Ensure-Node $xml.ossec_config "client"
    
    # --- Server Configuration ---
    $server = Ensure-Node $client "server"
    (Ensure-Node $server "address").InnerText = "{{ wazuh_manager_address }}"
    (Ensure-Node $server "port").InnerText = "{{ wazuh_manager_port | default('1514') }}"
    (Ensure-Node $server "protocol").InnerText = "{{ wazuh_manager_protocol | default('tcp') }}"

    # Save
    $xml.Save($path)
    
    # Verify not empty
    if ((Get-Item $path).Length -eq 0) {
        Write-Error "ossec.conf is empty after save!"
        exit 1
    }


- name: Import client key via manage_agents
  win_shell: |
    echo y | & "C:\Program Files (x86)\ossec-agent\manage_agents.exe" -i "{{ wazuh_client_key }}"
  args:
    executable: powershell
  register: import_key_result
  failed_when: 
    - import_key_result.rc != 0
    - '"Duplicate agent" not in import_key_result.stdout'
  when: wazuh_client_key is defined

- name: Restart Wazuh agent service
  win_service:
    name: WazuhSvc
    state: restarted

- name: Check Wazuh agent service status
  win_service:
    name: WazuhSvc
  register: agent_service_status

- name: Display agent status
  ansible.builtin.debug:
    msg: "Wazuh agent installed and started on {{ inventory_hostname }}. Service state: {{ agent_service_status.state }}"

