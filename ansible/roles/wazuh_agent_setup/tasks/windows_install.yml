---
- name: Ensure Temp Directory Exists
  win_file:
    path: C:\Temp
    state: directory

- name: Download Wazuh Agent MSI
  win_get_url:
    url: "{{ wazuh_agent_windows_url }}"
    dest: C:\Temp\wazuh-agent.msi
    force: no

- name: Install Wazuh Agent (Silent)
  win_package:
    path: C:\Temp\wazuh-agent.msi
    state: present
    arguments: /qn WAZUH_MANAGER={{ wazuh_manager_address }} WAZUH_REGISTRATION_SERVER={{ wazuh_manager_address }}

- name: Stop Wazuh agent service to prevent file locks
  win_service:
    name: WazuhSvc
    state: stopped

- name: Create Wazuh authd password file
  win_copy:
    content: "{{ wazuh_api_password }}"
    dest: "C:\\Program Files (x86)\\ossec-agent\\authd.pass"


- name: Configure Wazuh agent (Server & Enrollment)
  win_shell: |
    $path = "C:\Program Files (x86)\ossec-agent\ossec.conf"
    if (-not (Test-Path $path)) {
        Write-Error "ossec.conf not found at $path"
        exit 1
    }

    [xml]$xml = Get-Content $path
    $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)

    # Helper function to ensure node exists
    function Ensure-Node ($parent, $nodeName) {
        $node = $parent.SelectSingleNode($nodeName)
        if ($null -eq $node) {
            $node = $xml.CreateElement($nodeName)
            $parent.AppendChild($node) | Out-Null
        }
        return $node
    }

    # Ensure Structure
    $client = Ensure-Node $xml.ossec_config "client"
    
    # --- Server Configuration ---
    $server = Ensure-Node $client "server"
    (Ensure-Node $server "address").InnerText = "{{ wazuh_manager_address }}"
    (Ensure-Node $server "port").InnerText = "{{ wazuh_manager_port | default('1514') }}"
    (Ensure-Node $server "protocol").InnerText = "{{ wazuh_manager_protocol | default('tcp') }}"

    # --- Enrollment Configuration ---
    $enrollment = Ensure-Node $client "enrollment"
    (Ensure-Node $enrollment "enabled").InnerText = "yes"
    (Ensure-Node $enrollment "groups").InnerText = "{{ wazuh_target_groups }}"
    (Ensure-Node $enrollment "authorization_pass_path").InnerText = "C:\Program Files (x86)\ossec-agent\authd.pass"
    (Ensure-Node $enrollment "manager_address").InnerText = "{{ wazuh_manager_address }}"

    # Save
    $xml.Save($path)


- name: Restart Wazuh agent service
  win_service:
    name: WazuhSvc
    state: restarted

- name: Check Wazuh agent service status
  win_service:
    name: WazuhSvc
  register: agent_service_status

- name: Display agent status
  ansible.builtin.debug:
    msg: "Wazuh agent installed and started on {{ inventory_hostname }}. Service state: {{ agent_service_status.state }}"

