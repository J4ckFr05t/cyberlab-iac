---
- name: Install cassandra-driver pip package
  pip:
    name: cassandra-driver
    extra_args: --break-system-packages
    state: present

- name: Set CQLSH_NO_BUNDLED environment variable globally (optional but good for shell usage)
  lineinfile:
    path: /etc/environment
    regexp: '^CQLSH_NO_BUNDLED='
    line: 'CQLSH_NO_BUNDLED=true'

- name: Wait for Cassandra to be up
  wait_for:
    port: 9042
    delay: 10
    timeout: 300

# Robust Wait for Cassandra Authentication (Check all 3 possible states)
- name: Wait for Cassandra authentication to be available
  shell: |
    cqlsh -u admin -p "{{ authentication_cassandra_admin_password }}" -e "DESCRIBE KEYSPACES" && echo "admin_ok" && exit 0
    cqlsh -u cassandra -p cassandra -e "DESCRIBE KEYSPACES" && echo "default_ok" && exit 0
    cqlsh -u cassandra -p "{{ authentication_cassandra_password }}" -e "DESCRIBE KEYSPACES" && echo "new_pass_ok" && exit 0
    exit 1
  environment:
    CQLSH_NO_BUNDLED: "true"
  register: auth_check
  until: auth_check.rc == 0
  retries: 30
  delay: 10
  changed_when: false

# Determine valid credentials for bootstrapping (if admin not ready)
- name: Set bootstrapping credentials
  set_fact:
    bootstrap_user: "cassandra"
    bootstrap_pass: "{{ 'cassandra' if 'default_ok' in auth_check.stdout else authentication_cassandra_password }}"
  when: "'admin_ok' not in auth_check.stdout"

# Step 1: Create Admin Role if it doesn't exist (using whatever credentials work)
- name: Create admin role
  command: >
    cqlsh -u {{ bootstrap_user }} -p "{{ bootstrap_pass }}" -e "CREATE ROLE IF NOT EXISTS admin WITH PASSWORD = '{{ authentication_cassandra_admin_password }}' AND LOGIN = true AND SUPERUSER = true;"
  environment:
    CQLSH_NO_BUNDLED: "true"
  when: "'admin_ok' not in auth_check.stdout"

# Step 2: Now Admin exists. Use Admin for everything else.

# Check off security requirement: Change Default Cassandra Password
- name: Alter cassandra user password
  command: >
    cqlsh -u admin -p "{{ authentication_cassandra_admin_password }}" -e "ALTER USER cassandra WITH PASSWORD '{{ authentication_cassandra_password }}';"
  environment:
    CQLSH_NO_BUNDLED: "true"
  no_log: true
  # Always run this to ensure state, but idempotent roughly. 
  # Actually, if we just created admin, we should run this. 
  # If admin already existed, we might assume it's done, but re-running is safer to ensure compliance.

# The user asked to DROP ROLE cassandra.
- name: Drop default cassandra role
  command: >
    cqlsh -u admin -p "{{ authentication_cassandra_admin_password }}" -e "DROP ROLE IF EXISTS cassandra;"
  environment:
    CQLSH_NO_BUNDLED: "true"

# Setup TheHive Keyspace and Role
- name: Create TheHive keyspace
  command: >
    cqlsh -u admin -p "{{ authentication_cassandra_admin_password }}" -e "CREATE KEYSPACE IF NOT EXISTS thehive WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 1};"
  environment:
    CQLSH_NO_BUNDLED: "true"

- name: Create TheHive role
  command: >
    cqlsh -u admin -p "{{ authentication_cassandra_admin_password }}" -e "CREATE ROLE IF NOT EXISTS thehive WITH LOGIN = true AND PASSWORD = '{{ thehive_password }}';"
  environment:
    CQLSH_NO_BUNDLED: "true"
  no_log: true

- name: Grant permissions to TheHive role
  command: >
    cqlsh -u admin -p "{{ authentication_cassandra_admin_password }}" -e "GRANT ALL PERMISSIONS ON KEYSPACE thehive TO 'thehive';"
  environment:
    CQLSH_NO_BUNDLED: "true"
