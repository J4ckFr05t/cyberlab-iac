---
- name: Wait for TheHive to be ready
  wait_for:
    port: 9000
    host: localhost
    delay: 10
    timeout: 300

- name: Check if default admin credentials work
  uri:
    url: http://localhost:9000/api/v1/user/current
    user: "admin@thehive.local"
    password: "secret"
    force_basic_auth: yes
    status_code: [200, 401]
  register: default_auth_check
  failed_when: false

- name: Get current user ID (if default creds work)
  set_fact:
    current_user_id: "{{ default_auth_check.json._id }}"
  when: default_auth_check.status == 200

- name: Change default admin password
  uri:
    url: "http://localhost:9000/api/v1/user/{{ current_user_id }}/password/change"
    method: POST
    user: "admin@thehive.local"
    password: "secret"
    force_basic_auth: yes
    body_format: json
    body:
      password: "{{ thehive_password }}"
      currentPassword: "secret"
    status_code: [200, 204]
  when: default_auth_check.status == 200
  register: password_change

