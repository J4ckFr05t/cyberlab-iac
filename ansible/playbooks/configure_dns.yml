---
# Playbook to configure DNS settings on all hosts except pfSense and DC
# This playbook sets the DNS server to the Domain Controller IP address
# Supports both Windows and Linux hosts

- name: Configure DNS on Windows hosts
  hosts: windows
  gather_facts: yes
  
  vars:
    # Connection variables - use provided credentials
    ansible_user: "{{ win_username }}"
    ansible_password: "{{ win_password }}"
  
  vars_files:
    - ../group_vars/dc.yml
    - ../group_vars/windows_vault.yml
  tasks:
    - name: Get DC hostname and IP from inventory
      set_fact:
        dc_hostname: "{{ groups['dc'][0] }}"
        dc_ip: "{{ hostvars[groups['dc'][0]]['ansible_host'] }}"
        dc_fqdn: "{{ groups['dc'][0] }}.{{ domain_name }}"
      run_once: yes
      delegate_to: localhost

    - name: Display DNS configuration details
      debug:
        msg: "Configuring DNS to use DC: {{ dc_hostname }} ({{ dc_ip }}) - FQDN: {{ dc_fqdn }}"

    - name: Get network adapter information
      win_shell: |
        Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1 -ExpandProperty Name
      register: network_adapter
      changed_when: false

    - name: Set DNS server on Windows hosts
      win_dns_client:
        adapter_names: "{{ network_adapter.stdout | trim }}"
        dns_servers:
          - "{{ dc_ip }}"
      register: dns_result

    - name: Display DNS configuration result
      debug:
        msg: "DNS configured successfully on {{ inventory_hostname }}"
      when: dns_result is changed

    - name: Wait for DNS to propagate
      pause:
        seconds: 5
      when: dns_result is changed

    - name: Validate DNS resolution - Domain Controller
      win_shell: |
        try {
          $result = Resolve-DnsName -Name "{{ dc_fqdn }}" -ErrorAction Stop
          if ($result.IPAddress -contains "{{ dc_ip }}") {
            Write-Output "SUCCESS: Resolved {{ dc_fqdn }} to {{ dc_ip }}"
            exit 0
          } else {
            Write-Output "WARNING: Resolved {{ dc_fqdn }} but IP doesn't match. Got: $($result.IPAddress)"
            exit 1
          }
        } catch {
          Write-Output "FAILED: Cannot resolve {{ dc_fqdn }} - $($_.Exception.Message)"
          exit 2
        }
      register: dc_dns_validation
      changed_when: false
      failed_when: dc_dns_validation.rc == 2

    - name: Display DC DNS validation result
      debug:
        msg: "{{ dc_dns_validation.stdout_lines }}"

    - name: Validate DNS resolution - External (Google)
      win_shell: |
        try {
          $result = Resolve-DnsName -Name "google.com" -ErrorAction Stop
          Write-Output "SUCCESS: Can resolve google.com - External DNS working"
          exit 0
        } catch {
          Write-Output "FAILED: Cannot resolve google.com - $($_.Exception.Message)"
          exit 1
        }
      register: external_dns_validation
      changed_when: false
      failed_when: false

    - name: Display external DNS validation result
      debug:
        msg: "{{ external_dns_validation.stdout_lines }}"

    - name: Summary - DNS Configuration Status
      debug:
        msg:
          - "========================================="
          - "DNS Configuration Summary for {{ inventory_hostname }}"
          - "========================================="
          - "DNS Server: {{ dc_ip }} ({{ dc_hostname }})"
          - "Internal DNS ({{ dc_fqdn }}): {{ 'PASS ✓' if dc_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "External DNS (google.com): {{ 'PASS ✓' if external_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "========================================="

- name: Configure DNS on Linux hosts
  hosts: linux,infra
  gather_facts: yes
  
  vars_files:
    - ../group_vars/all.yml
  
  tasks:
    - name: Get DC hostname and IP from inventory
      set_fact:
        dc_hostname: "{{ groups['dc'][0] }}"
        dc_ip: "{{ hostvars[groups['dc'][0]]['ansible_host'] }}"
        dc_fqdn: "{{ groups['dc'][0] }}.{{ domain_name }}"
      run_once: yes

    - name: Display DNS configuration details
      debug:
        msg: "Configuring DNS to use DC: {{ dc_hostname }} ({{ dc_ip }}) - FQDN: {{ dc_fqdn }}"

    - name: Get active network connection name
      shell: |
        nmcli -t -f NAME,DEVICE connection show --active | grep "{{ ansible_default_ipv4.interface }}" | cut -d: -f1 | head -1
      register: active_connection
      changed_when: false
      become: yes

    - name: Display active connection
      debug:
        msg: "Configuring DNS for connection: {{ active_connection.stdout }} on interface {{ ansible_default_ipv4.interface }}"

    - name: Check if connection is managed by netplan
      shell: |
        if [[ "{{ active_connection.stdout }}" == netplan-* ]]; then
          echo "netplan"
        else
          echo "networkmanager"
        fi
      register: network_manager_type
      changed_when: false

    - name: Configure DNS via netplan (for netplan-managed connections)
      block:
        - name: Find the active netplan configuration file
          shell: |
            ls -t /etc/netplan/*.yaml | head -1
          register: netplan_file
          changed_when: false

        - name: Update netplan configuration with DC DNS
          blockinfile:
            path: "{{ netplan_file.stdout }}"
            marker: "# {mark} ANSIBLE MANAGED DNS CONFIGURATION"
            block: |
              network:
                version: 2
                ethernets:
                  {{ ansible_default_ipv4.interface }}:
                    nameservers:
                      addresses:
                        - {{ dc_ip }}
                      search:
                        - {{ domain_name }}
            create: no
          register: netplan_config

        - name: Apply netplan configuration
          command: netplan apply
          when: netplan_config is changed
          register: netplan_apply

        - name: Wait for network to stabilize
          wait_for:
            timeout: 5
          when: netplan_apply is changed

      become: yes
      when: network_manager_type.stdout == "netplan"

    - name: Configure DNS via NetworkManager (for non-netplan connections)
      block:
        - name: Configure DNS using nmcli (Strict Wipe)
          shell: |
            # Enable ignore-auto-dns first
            nmcli connection modify "{{ active_connection.stdout }}" ipv4.ignore-auto-dns yes
            nmcli connection modify "{{ active_connection.stdout }}" ipv6.ignore-auto-dns yes
            
            # CLEAR existing DNS list
            nmcli connection modify "{{ active_connection.stdout }}" ipv4.dns ""
            
            # Set NEW DNS list (single item)
            nmcli connection modify "{{ active_connection.stdout }}" ipv4.dns "{{ dc_ip }}"
            nmcli connection modify "{{ active_connection.stdout }}" ipv4.dns-search "{{ domain_name }}"
            
            # Set priority
            nmcli connection modify "{{ active_connection.stdout }}" ipv4.dns-priority -1
          register: nm_strict_config

        - name: Restart NetworkManager Service
          service:
            name: NetworkManager
            state: restarted
          when: nm_strict_config is changed
          async: 30
          poll: 0

        - name: Wait for network to come back up
          wait_for:
            timeout: 10
          when: nm_strict_config is changed

        - name: Verify connection settings (Config)
          command: nmcli -f ipv4.dns,ipv4.ignore-auto-dns connection show "{{ active_connection.stdout }}"
          register: nm_show_config
          changed_when: false

        - name: Display connection settings
          debug:
            msg: "{{ nm_show_config.stdout_lines }}"

      become: yes
      when: network_manager_type.stdout == "networkmanager"

    - name: Set config changed flag
      set_fact:
        nm_config:
          changed: "{{ (netplan_config is defined and netplan_config is changed) or (nm_direct_config is defined and nm_direct_config is changed) }}"

    - name: Display DNS configuration result
      debug:
        msg: "DNS configured successfully for interface {{ ansible_default_ipv4.interface }}"
      when: nm_config.changed

    - name: Wait for DNS to propagate
      pause:
        seconds: 3

    - name: Validate DNS resolution - Domain Controller
      shell: |
        if nslookup {{ dc_fqdn }} > /dev/null 2>&1; then
          echo "SUCCESS: Resolved {{ dc_fqdn }}"
          exit 0
        else
          echo "FAILED: Cannot resolve {{ dc_fqdn }}"
          exit 1
        fi
      register: dc_dns_validation
      changed_when: false
      failed_when: false

    - name: Display DC DNS validation result
      debug:
        msg: "{{ dc_dns_validation.stdout }}"

    - name: Validate DNS resolution - External (Google)
      shell: |
        if nslookup google.com > /dev/null 2>&1; then
          echo "SUCCESS: Can resolve google.com - External DNS working"
          exit 0
        else
          echo "FAILED: Cannot resolve google.com"
          exit 1
        fi
      register: external_dns_validation
      changed_when: false
      failed_when: false

    - name: Display external DNS validation result
      debug:
        msg: "{{ external_dns_validation.stdout }}"

    - name: Summary - DNS Configuration Status
      debug:
        msg:
          - "========================================="
          - "DNS Configuration Summary for {{ inventory_hostname }}"
          - "========================================="
          - "DNS Server: {{ dc_ip }} ({{ dc_hostname }})"
          - "Internal DNS ({{ dc_fqdn }}): {{ 'PASS ✓' if dc_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "External DNS (google.com): {{ 'PASS ✓' if external_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "========================================="
