---
# Playbook to configure DNS settings on all hosts except pfSense and DC
# This playbook sets the DNS server to the Domain Controller IP address
# Supports both Windows and Linux hosts

- name: Configure DNS on Windows hosts
  hosts: windows
  gather_facts: yes
  
  vars:
    # Connection variables - use provided credentials
    ansible_user: "{{ win_username }}"
    ansible_password: "{{ win_password }}"
  
  vars_files:
    - ../group_vars/dc.yml
    - ../group_vars/windows_vault.yml
  tasks:
    - name: Get DC hostname and IP from inventory
      set_fact:
        dc_hostname: "{{ groups['dc'][0] }}"
        dc_ip: "{{ hostvars[groups['dc'][0]]['ansible_host'] }}"
        dc_fqdn: "{{ groups['dc'][0] }}.{{ domain_name }}"
      run_once: yes
      delegate_to: localhost

    - name: Display DNS configuration details
      debug:
        msg: "Configuring DNS to use DC: {{ dc_hostname }} ({{ dc_ip }}) - FQDN: {{ dc_fqdn }}"

    - name: Get network adapter information
      win_shell: |
        Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1 -ExpandProperty Name
      register: network_adapter
      changed_when: false

    - name: Set DNS server on Windows hosts
      win_dns_client:
        adapter_names: "{{ network_adapter.stdout | trim }}"
        dns_servers:
          - "{{ dc_ip }}"
      register: dns_result

    - name: Display DNS configuration result
      debug:
        msg: "DNS configured successfully on {{ inventory_hostname }}"
      when: dns_result is changed

    - name: Wait for DNS to propagate
      pause:
        seconds: 5
      when: dns_result is changed

    - name: Validate DNS resolution - Domain Controller
      win_shell: |
        try {
          $result = Resolve-DnsName -Name "{{ dc_fqdn }}" -ErrorAction Stop
          if ($result.IPAddress -contains "{{ dc_ip }}") {
            Write-Output "SUCCESS: Resolved {{ dc_fqdn }} to {{ dc_ip }}"
            exit 0
          } else {
            Write-Output "WARNING: Resolved {{ dc_fqdn }} but IP doesn't match. Got: $($result.IPAddress)"
            exit 1
          }
        } catch {
          Write-Output "FAILED: Cannot resolve {{ dc_fqdn }} - $($_.Exception.Message)"
          exit 2
        }
      register: dc_dns_validation
      changed_when: false
      failed_when: dc_dns_validation.rc == 2

    - name: Display DC DNS validation result
      debug:
        msg: "{{ dc_dns_validation.stdout_lines }}"

    - name: Validate DNS resolution - External (Google)
      win_shell: |
        try {
          $result = Resolve-DnsName -Name "google.com" -ErrorAction Stop
          Write-Output "SUCCESS: Can resolve google.com - External DNS working"
          exit 0
        } catch {
          Write-Output "FAILED: Cannot resolve google.com - $($_.Exception.Message)"
          exit 1
        }
      register: external_dns_validation
      changed_when: false
      failed_when: false

    - name: Display external DNS validation result
      debug:
        msg: "{{ external_dns_validation.stdout_lines }}"

    - name: Summary - DNS Configuration Status
      debug:
        msg:
          - "========================================="
          - "DNS Configuration Summary for {{ inventory_hostname }}"
          - "========================================="
          - "DNS Server: {{ dc_ip }} ({{ dc_hostname }})"
          - "Internal DNS ({{ dc_fqdn }}): {{ 'PASS ✓' if dc_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "External DNS (google.com): {{ 'PASS ✓' if external_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "========================================="

- name: Configure DNS on Linux hosts (excluding DC)
  hosts: linux,infra
  gather_facts: yes
  
  vars:
    # Force SSH connection for Linux hosts
    ansible_connection: ssh
    ansible_port: 22
    # Clear any Windows-specific variables
    ansible_winrm_transport: null
    ansible_winrm_server_cert_validation: null
  
  vars_files:
    - ../group_vars/dc.yml
  tasks:
    - name: Get DC hostname and IP from inventory
      set_fact:
        dc_hostname: "{{ groups['dc'][0] }}"
        dc_ip: "{{ hostvars[groups['dc'][0]]['ansible_host'] }}"
        dc_fqdn: "{{ groups['dc'][0] }}.{{ domain_name }}"
      run_once: yes
      delegate_to: localhost

    - name: Display DNS configuration details
      debug:
        msg: "Configuring DNS to use DC: {{ dc_hostname }} ({{ dc_ip }}) - FQDN: {{ dc_fqdn }}"

    - name: Check if systemd-resolved is active
      systemd:
        name: systemd-resolved
      register: systemd_resolved_status
      failed_when: false

    - name: Configure DNS via systemd-resolved (Ubuntu/Debian with systemd-resolved)
      block:
        - name: Create resolved.conf.d directory
          file:
            path: /etc/systemd/resolved.conf.d
            state: directory
            mode: '0755'

        - name: Configure DNS in systemd-resolved
          copy:
            dest: /etc/systemd/resolved.conf.d/dns.conf
            content: |
              [Resolve]
              DNS={{ dc_ip }}
              FallbackDNS=
              Domains={{ domain_name }}
            mode: '0644'
          register: resolved_config

        - name: Restart systemd-resolved
          systemd:
            name: systemd-resolved
            state: restarted
          when: resolved_config is changed

        - name: Ensure /etc/resolv.conf is symlinked to systemd-resolved
          file:
            src: /run/systemd/resolve/stub-resolv.conf
            dest: /etc/resolv.conf
            state: link
            force: yes
      when: systemd_resolved_status.status is defined and systemd_resolved_status.status.ActiveState == "active"
      become: yes

    - name: Configure DNS via /etc/resolv.conf (Traditional method)
      block:
        - name: Backup existing resolv.conf
          copy:
            src: /etc/resolv.conf
            dest: /etc/resolv.conf.backup
            remote_src: yes
            force: no
          failed_when: false

        - name: Configure /etc/resolv.conf
          copy:
            dest: /etc/resolv.conf
            content: |
              # DNS Configuration - Managed by Ansible
              # Points to Domain Controller ({{ dc_hostname }})
              nameserver {{ dc_ip }}
              search {{ domain_name }}
            mode: '0644'
          register: resolv_config

        - name: Make resolv.conf immutable (prevent NetworkManager from overwriting)
          file:
            path: /etc/resolv.conf
            attributes: +i
          failed_when: false
          when: resolv_config is changed
      when: systemd_resolved_status.status is not defined or systemd_resolved_status.status.ActiveState != "active"
      become: yes

    - name: Wait for DNS to propagate
      pause:
        seconds: 3

    - name: Validate DNS resolution - Domain Controller
      shell: |
        if nslookup {{ dc_fqdn }} > /dev/null 2>&1; then
          echo "SUCCESS: Resolved {{ dc_fqdn }}"
          exit 0
        else
          echo "FAILED: Cannot resolve {{ dc_fqdn }}"
          exit 1
        fi
      register: dc_dns_validation
      changed_when: false
      failed_when: false

    - name: Display DC DNS validation result
      debug:
        msg: "{{ dc_dns_validation.stdout }}"

    - name: Validate DNS resolution - External (Google)
      shell: |
        if nslookup google.com > /dev/null 2>&1; then
          echo "SUCCESS: Can resolve google.com - External DNS working"
          exit 0
        else
          echo "FAILED: Cannot resolve google.com"
          exit 1
        fi
      register: external_dns_validation
      changed_when: false
      failed_when: false

    - name: Display external DNS validation result
      debug:
        msg: "{{ external_dns_validation.stdout }}"

    - name: Summary - DNS Configuration Status
      debug:
        msg:
          - "========================================="
          - "DNS Configuration Summary for {{ inventory_hostname }}"
          - "========================================="
          - "DNS Server: {{ dc_ip }} ({{ dc_hostname }})"
          - "Internal DNS ({{ dc_fqdn }}): {{ 'PASS ✓' if dc_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "External DNS (google.com): {{ 'PASS ✓' if external_dns_validation.rc == 0 else 'FAIL ✗' }}"
          - "========================================="
