---
- name: Manage Wazuh Groups and Assignments
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - ../inventory/group_vars/secret_vault.yml
  vars:
    wazuh_manager_address: "{{ hostvars['xdr-01-srv']['ansible_host'] }}"
    wazuh_api_port: 55000
    wazuh_api_proto: "https"
    wazuh_api_user: "wazuh"
    wazuh_api_validate_certs: false
    
    wazuh_agent_groups:
      - "windows-server"
      - "linux-server"
      - "linux-workstation"
      - "windows-workstation"

    wazuh_agent_assignments:
      - { agent_name: "dc-01-srv", group: "windows-server" }
      - { agent_name: "fleet-01-srv", group: "linux-server" }
      - { agent_name: "lin-01-ws", group: "linux-workstation" }
      - { agent_name: "siem-01-srv", group: "linux-server" }
      - { agent_name: "win-01-ws", group: "windows-workstation" }

  tasks:
    - name: Get Wazuh API token
      ansible.builtin.uri:
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/security/user/authenticate"
        method: POST
        user: "{{ wazuh_api_user }}"
        password: "{{ wazuh_api_password }}"
        force_basic_auth: yes
        status_code: [200]
        validate_certs: "{{ wazuh_api_validate_certs }}"
      register: api_token_response
      no_log: true

    - name: Set API token fact
      ansible.builtin.set_fact:
        wazuh_api_token: "{{ api_token_response.json.data.token }}"
      no_log: true

    - name: Create Wazuh Agent Groups
      ansible.builtin.uri:
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/groups"
        method: POST
        headers:
          Authorization: "Bearer {{ wazuh_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          group_id: "{{ item }}"
        status_code: [200, 422] # 422 if already exists (Wazuh 4.x behavior varies, sometimes 400 or 422)
        validate_certs: "{{ wazuh_api_validate_certs }}"
      loop: "{{ wazuh_agent_groups }}"
      register: create_group_response
      failed_when: 
        - create_group_response.status != 200
        # Check if error is "Resource already exists" (code 17004 or similar, checking message text)
        - "'already exists' not in create_group_response.json.message | default('')"
        - "'already exist' not in create_group_response.json.detail | default('')"

    - name: Get ID for each agent
      ansible.builtin.uri:
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/agents?name={{ item.agent_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ wazuh_api_token }}"
        validate_certs: "{{ wazuh_api_validate_certs }}"
      loop: "{{ wazuh_agent_assignments }}"
      register: agent_ids_response
      no_log: true

    - name: Assign Agents to Groups
      ansible.builtin.uri:
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/agents/{{ item.0.json.data.affected_items[0].id }}/group/{{ item.1.group }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ wazuh_api_token }}"
        validate_certs: "{{ wazuh_api_validate_certs }}"
        status_code: [200]
      loop: "{{ agent_ids_response.results | zip(wazuh_agent_assignments) | list }}"
      when: 
        - item.0.json.data.affected_items | length > 0
      loop_control:
        label: "Assigning {{ item.1.agent_name }} to {{ item.1.group }}"
