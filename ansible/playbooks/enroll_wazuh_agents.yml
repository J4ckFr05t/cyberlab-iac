---
- name: Install Wazuh Agent on Linux Hosts
  hosts: linux:!xdr-01-srv
  become: yes
  gather_facts: yes
  vars_files:
    # Attempt to load secrets if available.
    # User must ensure this file exists and contains 'wazuh_api_password'
    - ../inventory/group_vars/secret_vault.yml
  pre_tasks:
    - name: Verify wazuh_api_password is defined for API enrollment
      ansible.builtin.assert:
        that: wazuh_api_password is defined
        fail_msg: "The variable 'wazuh_api_password' is not defined. Please ensure it is defined in secret_vault.yml for API-based enrollment."
        quiet: true
      when: wazuh_api_password is not defined
  roles:
    - wazuh_agent_setup
  tags:
    - linux

- name: Install Wazuh Agent on Windows Hosts
  hosts: windows:dc
  gather_facts: yes
  vars:
    ansible_user: ".\\{{ win_username }}"
    ansible_password: "{{ win_password }}"
    ansible_connection: winrm
    ansible_winrm_transport: ntlm
    ansible_winrm_server_cert_validation: ignore
  vars_files:
    # Attempt to load secrets if available.
    # User must ensure this file exists and contains 'wazuh_api_password'
    - ../inventory/group_vars/secret_vault.yml
  pre_tasks:
    - name: Verify wazuh_api_password is defined for API enrollment
      ansible.builtin.assert:
        that: wazuh_api_password is defined
        fail_msg: "The variable 'wazuh_api_password' is not defined. Please ensure it is defined in secret_vault.yml for API-based enrollment."
        quiet: true
      when: wazuh_api_password is not defined
  roles:
    - wazuh_agent_setup
  tags:
    - windows

- name: Manage Wazuh Groups and Assignments
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - ../inventory/group_vars/secret_vault.yml
  vars:
    wazuh_manager_address: "{{ hostvars['xdr-01-srv']['ansible_host'] }}"
    wazuh_api_port: 55000
    wazuh_api_proto: "https"
    wazuh_api_user: "wazuh"
    wazuh_api_validate_certs: false
    
    wazuh_agent_groups:
      - "windows-server"
      - "linux-server"
      - "linux-workstation"
      - "windows-workstation"

    wazuh_agent_assignments:
      - { agent_name: "dc-01-srv", group: "windows-server" }
      - { agent_name: "fleet-01-srv", group: "linux-server" }
      - { agent_name: "lin-01-ws", group: "linux-workstation" }
      - { agent_name: "siem-01-srv", group: "linux-server" }
      - { agent_name: "win-01-ws", group: "windows-workstation" }

  tasks:
    - name: Get Wazuh API token
      ansible.builtin.uri:
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/security/user/authenticate"
        method: POST
        user: "{{ wazuh_api_user }}"
        password: "{{ wazuh_api_password }}"
        force_basic_auth: yes
        status_code: [200]
        validate_certs: "{{ wazuh_api_validate_certs }}"
      register: api_token_response
      no_log: true

    - name: Set API token fact
      ansible.builtin.set_fact:
        wazuh_api_token: "{{ api_token_response.json.data.token }}"
      no_log: true

    - name: Create Wazuh Agent Groups
      ansible.builtin.uri:
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/groups"
        method: POST
        headers:
          Authorization: "Bearer {{ wazuh_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          group_id: "{{ item }}"
        status_code: [200, 422] # 422 if already exists (Wazuh 4.x behavior varies, sometimes 400 or 422)
        validate_certs: "{{ wazuh_api_validate_certs }}"
      loop: "{{ wazuh_agent_groups }}"
      register: create_group_response
      failed_when: 
        - create_group_response.status != 200
        # Check if error is "Resource already exists" (code 17004 or similar, checking message text)
        - "'already exists' not in create_group_response.json.message | default('')"
        - "'already exist' not in create_group_response.json.detail | default('')"

    - name: Get Wazuh agent (check case variants)
      ansible.builtin.uri:
        # Check original, upper, and lower case to find existing agent efficiently
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/agents?q=name:{{ item.agent_name }},name:{{ item.agent_name | upper }},name:{{ item.agent_name | lower }}"
        method: GET
        headers:
          Authorization: "Bearer {{ wazuh_api_token }}"
        validate_certs: "{{ wazuh_api_validate_certs }}"
      register: agent_search_response
      no_log: true
      loop: "{{ wazuh_agent_assignments }}"

    - name: Assign Agents to Groups (default + specific)
      ansible.builtin.uri:
        # Assign to 'default' and the specific group using query parameter for multiple groups
        url: "{{ wazuh_api_proto }}://{{ wazuh_manager_address }}:{{ wazuh_api_port }}/agents/{{ my_agent_id }}/group?group_id=default,{{ item.1.group }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ wazuh_api_token }}"
        validate_certs: "{{ wazuh_api_validate_certs }}"
        status_code: [200]
      vars:
        # From the search results (which might contain 1 or 2 matching variants), pick the best one.
        # Use case-insensitive match against expected name just to be sure, or pick first.
        my_agent: "{{ item.0.json.data.affected_items | selectattr('name', 'search', '^' ~ item.1.agent_name ~ '$', ignorecase=True) | first | default({}) }}"
        my_agent_id: "{{ my_agent.id | default('') }}"
      loop: "{{ agent_search_response.results | zip(wazuh_agent_assignments) | list }}"
      when: 
        - my_agent_id != ''
      loop_control:
        label: "Assigning {{ item.1.agent_name }} (ID: {{ my_agent_id }}) to default,{{ item.1.group }}"
