---
###############################################################################
# atomic_red_team_attack.yml - Atomic Red Team Test Execution Playbook
###############################################################################
#
# Dynamically executes Atomic Red Team tests on mixed Windows/Linux hosts.
# Accepts MITRE ATT&CK technique IDs at runtime via JSON extra variables.
#
# Windows: Uses Invoke-AtomicTest PowerShell module via win_shell.
# Linux:   Uses Invoke-AtomicTest PowerShell module via pwsh (PowerShell Core).
#
# Techniques not applicable to a host's OS are silently skipped.
# No technique IDs are hardcoded in this playbook.
#
# USAGE:
#   cd /Users/jibingeorge/Documents/cyberlab-iac/ansible
#
#   # Run specific techniques across all hosts:
#   ansible-playbook playbooks/atomic_red_team_attack.yml \
#     -e '{"techniques": ["T1003.001", "T1003.008"]}'
#
#   # Run a single technique:
#   ansible-playbook playbooks/atomic_red_team_attack.yml \
#     -e '{"techniques": ["T1059.001"]}'
#
#   # Dry-run to preview task execution:
#   ansible-playbook playbooks/atomic_red_team_attack.yml \
#     -e '{"techniques": ["T1003.001", "T1003.008"]}' --check
#
#   # Limit to specific hosts:
#   ansible-playbook playbooks/atomic_red_team_attack.yml \
#     -e '{"techniques": ["T1059.001"]}' --limit windows
#
# PREREQUISITES:
#   Windows — Invoke-AtomicRedTeam PowerShell module installed:
#     Install-Module -Name invoke-atomicredteam -Scope CurrentUser -Force
#     Install-Module -Name powershell-yaml -Scope CurrentUser -Force
#     Install-AtomicRedTeam -getAtomics -Force
#
#   Linux — PowerShell Core (pwsh) + Invoke-AtomicRedTeam module:
#     1. Install PowerShell:
#        ansible-playbook playbooks/install_powershell.yml
#     2. Install Invoke-AtomicRedTeam module:
#        pwsh -Command "Install-Module -Name invoke-atomicredteam -Scope CurrentUser -Force"
#        pwsh -Command "Install-Module -Name powershell-yaml -Scope CurrentUser -Force"
#        pwsh -Command "Install-AtomicRedTeam -getAtomics -Force"
#
###############################################################################

###############################################################################
# PLAY 1: Execute Atomic Red Team tests on WINDOWS hosts
###############################################################################
- name: "Atomic Red Team - Windows Execution"
  hosts: dc,windows
  gather_facts: true

  vars_files:
    - ../inventory/group_vars/secret_vault.yml

  vars:
    ansible_user: "{{ win_username }}"
    ansible_password: "{{ win_password }}"

  tasks:
    # Validate that techniques were passed at runtime
    - name: "Validate 'techniques' variable is provided"
      ansible.builtin.assert:
        that:
          - techniques is defined
          - techniques | length > 0
        fail_msg: >-
          ERROR: Pass technique IDs at runtime.
          Example: -e '{"techniques": ["T1003.001", "T1003.008"]}'
      run_once: true
      tags: [always]

    - name: "Display Windows execution plan"
      ansible.builtin.debug:
        msg: "[{{ inventory_hostname }}] Running {{ techniques | length }} technique(s): {{ techniques | join(', ') }}"
      when: ansible_os_family == 'Windows'
      tags: [always]

    # Execute each technique — Invoke-AtomicTest natively skips techniques
    # that have no tests for Windows (e.g., Linux-only techniques like T1003.008)
    - name: "Execute Atomic Test: {{ item }}"
      ansible.windows.win_shell: |
        Import-Module "C:\AtomicRedTeam\invoke-atomicredteam\Invoke-AtomicRedTeam.psd1" -Force
        Invoke-AtomicTest {{ item }} -GetPrereqs -ErrorAction SilentlyContinue
        Invoke-AtomicTest {{ item }} -Confirm:$false
      loop: "{{ techniques }}"
      loop_control:
        label: "{{ item }}"
      when: ansible_os_family == 'Windows'
      register: windows_results
      ignore_errors: true
      failed_when: false
      tags: [attack, windows]

    # Save results for summary
    - name: "Store Windows results"
      ansible.builtin.set_fact:
        attack_results: "{{ windows_results.results | default([]) }}"
      when: ansible_os_family == 'Windows'
      tags: [always]

###############################################################################
# PLAY 2: Execute Atomic Red Team tests on LINUX hosts (via PowerShell Core)
###############################################################################
- name: "Atomic Red Team - Linux Execution"
  hosts: linux
  gather_facts: true

  tasks:
    - name: "Display Linux execution plan"
      ansible.builtin.debug:
        msg: "[{{ inventory_hostname }}] Running {{ techniques | length }} technique(s): {{ techniques | join(', ') }}"
      when: ansible_os_family != 'Windows'
      tags: [always]

    # Execute each technique using Invoke-AtomicTest via PowerShell Core (pwsh).
    # This mirrors the Windows execution approach for consistency.
    # Techniques without Linux tests are silently skipped by Invoke-AtomicTest.
    - name: "Execute Atomic Test: {{ item }}"
      ansible.builtin.shell: |
        pwsh -Command '
          Import-Module "/root/AtomicRedTeam/invoke-atomicredteam/Invoke-AtomicRedTeam.psd1" -Force
          Invoke-AtomicTest {{ item }} -GetPrereqs -ErrorAction SilentlyContinue
          Invoke-AtomicTest {{ item }} -Confirm:$false
        '
      loop: "{{ techniques }}"
      loop_control:
        label: "{{ item }}"
      when: ansible_os_family != 'Windows'
      register: linux_results
      ignore_errors: true
      failed_when: false
      become: true
      tags: [attack, linux]

    # Save results for summary
    - name: "Store Linux results"
      ansible.builtin.set_fact:
        attack_results: "{{ linux_results.results | default([]) }}"
      when: ansible_os_family != 'Windows'
      tags: [always]

###############################################################################
# PLAY 3: Summary — Clean per-host execution report
###############################################################################
- name: "Atomic Red Team - Execution Summary"
  hosts: all
  gather_facts: false

  vars_files:
    - ../inventory/group_vars/secret_vault.yml

  vars:
    ansible_user: "{{ win_username | default(omit) }}"
    ansible_password: "{{ win_password | default(omit) }}"

  tasks:
    - name: "Execution Report for {{ inventory_hostname }}"
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║           ATOMIC RED TEAM — EXECUTION REPORT                   ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║  Host:     {{ inventory_hostname }}
          ║  OS:       {{ ansible_os_family | default('Unknown') }}
          ║  ──────────────────────────────────────────────────────────────
          {% for result in attack_results | default([]) %}
          {% if result.skipped | default(false) %}
          ║  ⏭  SKIPPED   {{ result.item }}
          {% elif result.rc | default(0) == 0 %}
          ║  ✅ SUCCESS   {{ result.item }}
          {% else %}
          ║  ❌ FAILED    {{ result.item }}  (exit code: {{ result.rc | default('?') }})
          {% endif %}
          {% endfor %}
          {% if attack_results | default([]) | length == 0 %}
          ║  ℹ️  No techniques were evaluated on this host.
          {% endif %}
          ╚══════════════════════════════════════════════════════════════════╝
      tags: [always, summary]
